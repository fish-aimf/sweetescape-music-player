name: Daily BrowserStack Capture

permissions:
  contents: write

on:
  schedule:
    - cron: "30 10 * * *"
  workflow_dispatch:

jobs:
  run-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Selenium
        run: npm install selenium-webdriver

      - name: Run BrowserStack Script
        run: |
          # Create folder if missing
          mkdir -p captures
          
          # Generate filename based on date and export it
          export EXPORT_FILE="captures/billboard-$(date +%F).txt"

          node - << EOF
          const fs = require("fs");
          const webdriver = require("selenium-webdriver");
          const { By } = webdriver;

          const caps = {
            browserName: "Safari",
            browserVersion: "17.3",
            "bstack:options": {
              os: "OS X",
              osVersion: "Sonoma"
            }
          };

          (async () => {
            const driver = new webdriver.Builder()
              .usingServer(
                'https://${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}@hub.browserstack.com/wd/hub'
              )
              .withCapabilities(caps)
              .build();

            await driver.get("https://sweetescape.vercel.app/billboard.html");

            await new Promise(r => setTimeout(r, 60000));

            const text = await driver.findElement(By.css("body")).getText();

            // Save to exported filename
            fs.writeFileSync(process.env.EXPORT_FILE, text);

            await driver.quit();
          })();
          EOF

      - name: Commit updated capture file
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git pull --rebase

          git add captures/*.txt
          git commit -m "Daily capture $(date +%F)" || echo "No changes to commit"
          git push
