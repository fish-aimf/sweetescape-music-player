name: Daily BrowserStack Capture

on:
  schedule:
    # Runs daily at 18:35 GMT+8
    - cron: "35 10 * * *"
  workflow_dispatch:    # Optional: manual trigger

jobs:
  run-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Selenium
        run: npm install selenium-webdriver

      - name: Run BrowserStack Script
        env:
          BS_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          node - << 'EOF'
          const fs = require("fs");
          const webdriver = require("selenium-webdriver");
          const { By } = webdriver;

          const caps = {
            browserName: "Safari",
            browserVersion: "17.3",
            "bstack:options": {
              os: "OS X",
              osVersion: "Sonoma"
            }
          };

          (async () => {
            const driver = new webdriver.Builder()
              .usingServer(
                `https://${process.env.BS_USER}:${process.env.BS_KEY}@hub.browserstack.com/wd/hub`
              )
              .withCapabilities(caps)
              .build();

            await driver.get("https://sweetescape.vercel.app/billboard.html");

            // Wait 1 minute for page to fully update
            await new Promise(r => setTimeout(r, 60000));

            // Capture all visible text
            const text = await driver.findElement(By.css("body")).getText();

            fs.writeFileSync("output.txt", text);

            await driver.quit();
          })();
          EOF

      - name: Commit updated output.txt
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add output.txt
          git commit -m "Daily update $(date)" || echo "No changes to commit"
          git push
