<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billboard Hot 100 Updater</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        #log { white-space: pre-wrap; line-height: 1.6; }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #00aaff; }
        .warning { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>Billboard Hot 100 Updater</h1>
    <div id="log"></div>
    
    <script>
        const SUPABASE_URL = 'https://cwhxanbpymkngzpbsshh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aHhhbmJweW1rbmd6cGJzc2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTQzMTksImV4cCI6MjA2OTQzMDMxOX0.6K3eM1XoWaPmyMHsLYgw0mAnSxYjME4clflL4PxQalQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const YOUTUBE_API_KEYS = [
            'AIzaSyDPT2lmIab9DPC-ltZh4sWrlhapwp0mgTA',
            'AIzaSyAENxiCNCZPHgPt2-ip4-GUWcLTkxge8tc',
            'AIzaSyCDKrOQyGllinvpfd-WxT-GLk-0fqeBPg4',
            'AIzaSyC4j5HXlRifuJr-1kjxbNVxzu_xvVxniqs',
            'AIzaSyBTm9f2GN9fu1sBnvq9gEW4Scck3-0NIP0',
            'AIzaSyAxyLInnmvbWI9AnX9kOIHdSsaZFwfEpX4',
            'AIzaSyBgNN14Ql_9ZzyNed0mS-KLt1l1ucieI9s'
        ];
        let activeKeyIndex = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function searchYouTube(songTitle, artist) {
            const query = `${songTitle} ${artist} official`;
            
            for (let attempt = 0; attempt < YOUTUBE_API_KEYS.length; attempt++) {
                const apiKey = YOUTUBE_API_KEYS[activeKeyIndex];
                
                try {
                    const response = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`
                    );
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            log(`Key ${activeKeyIndex + 1} quota exceeded, rotating...`, 'warning');
                            activeKeyIndex = (activeKeyIndex + 1) % YOUTUBE_API_KEYS.length;
                            continue;
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        const bestMatch = findBestMatch(data.items, songTitle, artist);
                        return bestMatch ? `https://www.youtube.com/watch?v=${bestMatch.id.videoId}` : null;
                    }
                    return null;
                } catch (error) {
                    log(`Error with key ${activeKeyIndex + 1}: ${error.message}`, 'error');
                    activeKeyIndex = (activeKeyIndex + 1) % YOUTUBE_API_KEYS.length;
                }
            }
            
            return null;
        }
        
        function findBestMatch(items, songTitle, artist) {
            const scored = items.map(item => {
                const title = item.snippet.title.toLowerCase();
                const channel = item.snippet.channelTitle.toLowerCase();
                let score = 0;
                
                if (title.includes(songTitle.toLowerCase())) score += 30;
                if (title.includes(artist.toLowerCase())) score += 20;
                if (channel.includes(artist.toLowerCase()) || channel.includes('vevo') || channel.includes('official')) score += 25;
                if (title.includes('official')) score += 15;
                
                return { ...item, score };
            });
            
            scored.sort((a, b) => b.score - a.score);
            return scored[0]?.score > 20 ? scored[0] : null;
        }
        
        async function updateBillboard() {
            log('=== Starting Billboard Hot 100 Update ===', 'info');
            
            try {
                // Fetch Billboard data
                log('Fetching Billboard Hot 100 data...', 'info');
                const response = await fetch('https://raw.githubusercontent.com/mhollingshead/billboard-hot-100/main/recent.json');
                const billboardData = await response.json();
                log(`Fetched ${billboardData.data.length} songs`, 'success');
                
                // Get existing data
                const { data: existingData } = await supabase
                    .from('billboard_hot_100')
                    .select('*');
                
                const existingMap = new Map(existingData?.map(item => [item.id, item]) || []);
                
                let totalProcessed = 0;
                let totalUpdated = 0;
                let totalSkipped = 0;
                let totalYouTubeSearches = 0;
                
                // Process each song
                for (let i = 0; i < Math.min(billboardData.data.length, 100); i++) {
                    const song = billboardData.data[i];
                    const id = i + 1;
                    totalProcessed++;
                    
                    log(`\n[${id}/100] Processing: "${song.song}" by ${song.artist}`, 'info');
                    
                    const existing = existingMap.get(id);
                    let youtubeUrl = existing?.youtube_url;
                    let needsUpdate = false;
                    
                    // Check if ANY field changed
                    if (!existing) {
                        log(`  New entry - needs full update`, 'info');
                        needsUpdate = true;
                    } else {
                        const changes = [];
                        if (existing.song !== song.song) changes.push('song');
                        if (existing.artist !== song.artist) changes.push('artist');
                        if (existing.this_week !== song.this_week) changes.push('position');
                        if (existing.last_week !== song.last_week) changes.push('last_week');
                        if (existing.peak_position !== song.peak_position) changes.push('peak');
                        if (existing.weeks_on_chart !== song.weeks_on_chart) changes.push('weeks');
                        
                        if (changes.length > 0) {
                            log(`  Changes detected: ${changes.join(', ')}`, 'warning');
                            needsUpdate = true;
                        } else {
                            log(`  No changes - skipping`, 'info');
                            totalSkipped++;
                            continue;
                        }
                    }
                    
                    // Only search YouTube if song/artist changed or no URL exists
                    if (!existing || existing.song !== song.song || existing.artist !== song.artist || !youtubeUrl) {
                        log(`  Searching YouTube...`, 'info');
                        youtubeUrl = await searchYouTube(song.song, song.artist);
                        totalYouTubeSearches++;
                        
                        if (youtubeUrl) {
                            log(`  Found: ${youtubeUrl}`, 'success');
                        } else {
                            log(`  No match found`, 'warning');
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100)); // Rate limit
                    } else {
                        log(`  Using existing URL`, 'info');
                    }
                    
                    // Only update if needed
                    if (needsUpdate) {
                        const { error } = await supabase
                            .from('billboard_hot_100')
                            .upsert({
                                id: id,
                                song: song.song,
                                artist: song.artist,
                                this_week: song.this_week,
                                last_week: song.last_week,
                                peak_position: song.peak_position,
                                weeks_on_chart: song.weeks_on_chart,
                                youtube_url: youtubeUrl,
                                last_updated: new Date().toISOString()
                            });
                        
                        if (error) {
                            log(`  Database error: ${error.message}`, 'error');
                        } else {
                            log(`  Updated in database`, 'success');
                            totalUpdated++;
                        }
                    }
                }
                
                // Update top 3 table
                log('\n=== Updating Top 3 Table ===', 'info');
                
                const { data: existingTop3 } = await supabase
                    .from('billboard_top_3')
                    .select('*')
                    .order('position');
                
                const existingTop3Map = new Map(existingTop3?.map(item => [item.position, item]) || []);
                
                let top3Updated = 0;
                let top3Skipped = 0;
                
                for (let i = 0; i < 3; i++) {
                    const song = billboardData.data[i];
                    const position = i + 1;
                    
                    log(`\nTop ${position}: "${song.song}" by ${song.artist}`, 'info');
                    
                    const existing = existingTop3Map.get(position);
                    let youtubeUrl = null;
                    let needsUpdate = false;
                    
                    // Check if changed
                    if (!existing || existing.song !== song.song || existing.artist !== song.artist) {
                        needsUpdate = true;
                        log(`  Changes detected in top 3`, 'warning');
                        
                        // Get YouTube URL from main table
                        const { data: mainTableData } = await supabase
                            .from('billboard_hot_100')
                            .select('youtube_url')
                            .eq('id', position)
                            .single();
                        
                        youtubeUrl = mainTableData?.youtube_url;
                    } else {
                        log(`  No changes in top 3 - skipping`, 'info');
                        top3Skipped++;
                        continue;
                    }
                    
                    if (needsUpdate) {
                        const { error } = await supabase
                            .from('billboard_top_3')
                            .upsert({
                                position: position,
                                song: song.song,
                                artist: song.artist,
                                youtube_url: youtubeUrl,
                                last_updated: new Date().toISOString()
                            });
                        
                        if (error) {
                            log(`  Top 3 database error: ${error.message}`, 'error');
                        } else {
                            log(`  Top 3 updated in database`, 'success');
                            top3Updated++;
                        }
                    }
                }
                
                log('\n=== Update Summary ===', 'success');
                log(`Total songs processed: ${totalProcessed}`, 'info');
                log(`Songs updated: ${totalUpdated}`, 'success');
                log(`Songs skipped (no changes): ${totalSkipped}`, 'info');
                log(`YouTube searches performed: ${totalYouTubeSearches}`, 'warning');
                log(`\nTop 3 updated: ${top3Updated}`, 'success');
                log(`Top 3 skipped: ${top3Skipped}`, 'info');
                log('\n=== Update Complete ===', 'success');
                
            } catch (error) {
                log(`\nFATAL ERROR: ${error.message}`, 'error');
            }
        }
        
        // Start update on page load
        updateBillboard();
    </script>
</body>
</html>
